schema_version: 1.0
plan_id: "plan-2025-11-01-001"
name: "Refactor AgentFlow Core Module"
description: >
  Demonstration plan that shows how the planner, runner, and UI cooperate.
  The first nodes are completed, a current node is executing, and later
  nodes remain pending to illustrate state transitions.
created_at: "2025-11-01T21:15:00Z"
last_updated: "2025-11-01T21:24:12Z"
created_by: "dev@user.com"
version: 3
status: running
tags:
  - refactor
  - agentflow
context:
  repository: "github.com/example/agentflow"
  branch: "feature/refactor-core"
  objective: "Improve planner/executor separation and add telemetry hooks."
  notes: >
    Derived from RFC-12. Runner locked plan prior to execution.
vars:
  target_file: "src/agentflow/core.py"
  reviewer: "code.reviewer@example.com"
metrics:
  total_nodes: 5
  completed: 2
  in_progress: 1
  pending: 1
  blocked: 1
  success_rate: 40
nodes:
  - id: gather_context
    type: agent
    summary: "Summarize current implementation and pain points."
    depends_on: []
    status: succeeded
    attempt: 1
    inputs:
      prompt: |
        Read {{ vars.target_file }}.
        Summarize key responsibilities and current sources of complexity.
        Focus on planner and executor coupling.
    outputs:
      synopsis: >
        Core module mixes planning and execution concerns; needs interface split.
      raw: |
        - Planner uses Executor directly without abstraction.
        - Logging is scattered and not structured.
    artifacts:
      - type: markdown
        path: "logs/gather_context.md"
    metrics:
      tokens_input: 1240
      tokens_output: 210
    timeline:
      queued_at: "2025-11-01T21:15:10Z"
      started_at: "2025-11-01T21:15:12Z"
      ended_at: "2025-11-01T21:15:35Z"
      duration_seconds: 23
    history:
      - attempt_id: 1
        timestamp: "2025-11-01T21:15:35Z"
        status: succeeded
        notes: "LLM response accepted."

  - id: design_interface_split
    type: agent
    summary: "Propose a modular boundary between planner and executor."
    depends_on:
      - gather_context
    status: succeeded
    attempt: 1
    inputs:
      prompt: |
        Based on {{ nodes.gather_context.outputs.synopsis }},
        propose module boundaries and data contracts.
        Return a diff-ready summary.
    outputs:
      synopsis: >
        Introduce PlannerService and ExecutionService with shared PlanState DTO.
      raw: |
        PlannerService.prepare_plan(plan_yaml) -> PlanState
        ExecutionService.run_step(plan_state, node_id) -> NodeResult
    artifacts:
      - type: markdown
        path: "logs/design_interface_split.md"
    metrics:
      tokens_input: 980
      tokens_output: 340
    timeline:
      queued_at: "2025-11-01T21:15:36Z"
      started_at: "2025-11-01T21:15:38Z"
      ended_at: "2025-11-01T21:16:02Z"
      duration_seconds: 24
    history:
      - attempt_id: 1
        timestamp: "2025-11-01T21:16:02Z"
        status: succeeded
        notes: "Reviewed by automation engineer; accepted."

  - id: implement_split
    type: tool
    summary: "Apply refactor to separate planner/executor classes."
    depends_on:
      - design_interface_split
    status: in_progress
    attempt: 2
    inputs:
      command: |
        python tools/refactor.py --plan "{{ plan_id }}" --target "{{ vars.target_file }}"
    outputs:
      synopsis: "Second attempt running; awaiting completion."
    artifacts:
      - type: log
        path: "logs/implement_split-attempt1.log"
    metrics:
      attempts: 2
    timeline:
      queued_at: "2025-11-01T21:16:05Z"
      started_at: "2025-11-01T21:22:40Z"
    history:
      - attempt_id: 1
        timestamp: "2025-11-01T21:18:14Z"
        status: failed
        notes: "Refactor script exited non-zero; module import error."
      - attempt_id: 2
        timestamp: "2025-11-01T21:22:40Z"
        status: in_progress
        notes: "Runner re-queued after fixing requirements.txt."

  - id: run_regression_tests
    type: tool
    summary: "Execute regression test suite."
    depends_on:
      - implement_split
    status: pending
    attempt: 0
    inputs:
      command: |
        tox -e py310
    outputs: {}
    artifacts: []
    metrics: {}
    timeline: {}
    history: []

  - id: notify_reviewer
    type: service
    summary: "Notify reviewer with diff and summary."
    depends_on:
      - run_regression_tests
    status: blocked
    attempt: 0
    inputs:
      request:
        method: POST
        url: "https://hooks.slack.com/services/T123/AGENTFLOW/REVIEW"
        headers:
          Content-Type: "application/json"
        body:
          reviewer: "{{ vars.reviewer }}"
          plan_id: "{{ plan_id }}"
          summary: "Planner/executor split; see attached artifacts."
    outputs: {}
    artifacts: []
    metrics: {}
    timeline: {}
    history:
      - attempt_id: 0
        timestamp: "2025-11-01T21:24:12Z"
        status: blocked
        notes: "Waiting for run_regression_tests to finish."

rollup:
  completion_percentage: 50
  critical_path: ["gather_context", "design_interface_split", "implement_split", "run_regression_tests"]
  alerts:
    - severity: warning
      message: "implement_split failed once; monitor second attempt."
  last_writer: "agentflow-runner@local"
